<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>GanhaPlus ‚Äî Tarefas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>

<body class="theme-dark dashboard-page">

  <!-- Bot√£o hamb√∫rguer -->
  <button id="toggle-sidebar" class="btn-hamburger" aria-label="Menu">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2 class="brand">GanhaPlus</h2>
      <span class="tag">Menu</span>
    </div>
    <nav class="menu">
      <a href="principal.html">üè† Painel</a>
      <a class="active" href="tarefa.html">üéØ Tarefas</a>
      <a href="historico.html">üìú Hist√≥rico</a>
      <a href="saque.html">üí∏ Saque</a>
    </nav>
    <button id="btn-logout" class="logout-btn">Sair</button>
  </aside>

  <!-- Conte√∫do principal -->
  <main class="main-content">
    <header class="topbar">
      <h1>Tarefas Dispon√≠veis</h1>
      <p class="subtitle">Assista v√≠deos e compartilhe links para ganhar <b>500 AOA</b></p>
      <p id="limite-anuncios" class="limite-info">
        Voc√™ pode assistir <b>20 v√≠deos a cada 8 horas</b>.
      </p>
    </header>

    <section class="section-block">
      <h2 class="section-title">A√ß√µes</h2>
      <div class="tarefas-row">

        <!-- Assistir v√≠deo -->
        <div class="tarefa-card">
          <h3>Assistir V√≠deos</h3>
          <p>+500 AOA por v√≠deo (4 an√∫ncios cada v√≠deo)</p>
          <button id="btn-assistir" class="btn-primary">Assistir V√≠deo</button>
        </div>

        <!-- Compartilhar link -->
        <div class="tarefa-card">
          <h3>Compartilhar Link</h3>
          <p>+500 AOA por compartilhamento</p>
          <button id="btn-compartilhar" class="btn-primary">Compartilhar</button>
        </div>

      </div>
    </section>
  </main>

  <script src="app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // Toggle Sidebar
      const toggleBtn = document.getElementById("toggle-sidebar");
      const sidebar = document.querySelector(".sidebar");
      toggleBtn.addEventListener("click", () => {
        sidebar.classList.toggle("sidebar-hidden");
        toggleBtn.classList.toggle("active");
      });

      // Logout
      document.getElementById('btn-logout')?.addEventListener('click', () => {
        localStorage.removeItem('gp_token');
        window.location.href = 'login.html';
      });

      // Assistir v√≠deo: abre 4 an√∫ncios consecutivos
      document.getElementById('btn-assistir')?.addEventListener('click', async () => {
        try {
          const TOTAL_ADS = 4; // Cada v√≠deo = 4 an√∫ncios
          for (let i = 0; i < TOTAL_ADS; i++) {
            await abrirSequenciaAnuncios(); // Fun√ß√£o do app.js
          }
          alert(`+500 AOA creditados pelo v√≠deo!`);
          await carregarPainel(); // Atualiza saldo
        } catch (err) {
          console.error("Erro ao assistir an√∫ncios:", err);
          alert('Erro ao assistir os an√∫ncios. Tente novamente.');
        }
      });

      // Compartilhar link
      document.getElementById('btn-compartilhar')?.addEventListener('click', async () => {
        try {
          const perfil = await obterUsuario();
          if (!perfil) return alert('Voc√™ precisa estar logado para compartilhar.');

          const link = `${window.location.origin}/?ref=${perfil.id}`;
          const link_id = `ref-${perfil.id}-${Date.now()}`;
          const slogan = 'üî• GANHA 500 AOA com GanhaPlus! üî•';
          const fullText = `${slogan}\nConfira: ${link}`;

          // Copiar link para √°rea de transfer√™ncia
          await navigator.clipboard.writeText(fullText);

          // Registrar no backend
          const { ok, dados } = await requestSeguro(`${BASE_URL}/api/compartilhar`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + localStorage.getItem('gp_token')
            },
            body: JSON.stringify({ link_id, plataforma: "Gen√©rico" })
          });

          if (!ok) return alert(dados?.erro || "Erro ao registrar compartilhamento");

          // Pergunta se deseja abrir redes sociais
          const abrirRedes = confirm('Deseja compartilhar agora em redes sociais?');
          if (abrirRedes) {
            const urlFacebook = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
            const urlTwitter = `https://twitter.com/intent/tweet?text=${encodeURIComponent(fullText)}`;
            const urlWhatsApp = `https://wa.me/?text=${encodeURIComponent(fullText)}`;

            window.open(urlFacebook, '_blank');
            window.open(urlTwitter, '_blank');
            window.open(urlWhatsApp, '_blank');
          }

          alert('Link copiado e registrado com sucesso! Compartilhe para ganhar 500 AOA.');

        } catch (err) {
          console.error("Erro ao compartilhar:", err);
          alert('N√£o foi poss√≠vel gerar ou registrar o link. Tente novamente.');
        }
      });

    });
  </script>
</body>
</html>
